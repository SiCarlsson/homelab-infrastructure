- name: Install Traefik (simple setup)
  hosts: local_docker_hosts
  become: yes
  gather_facts: yes

  roles:
    - role: ../roles/traefik

  post_tasks:
    - name: Check Traefik container status
      command: docker compose ps --services --filter status=running
      args:
        chdir: /opt/traefik
      register: traefik_running_services
      changed_when: false

    - name: Verify Traefik container is running
      assert:
        that:
          - traefik_running_services.stdout_lines | length > 0
        fail_msg: "Traefik container is not running"
        success_msg: "Traefik container is running successfully"

    - name: Check Traefik dashboard connectivity
      uri:
        url: "http://{{ ansible_host }}:8080"
        method: GET
        timeout: 10
      register: traefik_dashboard_check
      failed_when: false
      changed_when: false

    - name: Display setup completion
      debug:
        msg:
          - "ğŸ‰ Traefik setup completed successfully!"
          - "ğŸ“Š Dashboard: http://{{ ansible_host }}:8080 {% if traefik_dashboard_check.status == 200 %}âœ… (accessible){% else %}âŒ (check connection){% endif %}"
          - "ğŸ”§ Your apps will be available on port 80"
          - "ğŸŒ Traefik network created and ready for services"
          - "{% if traefik_enable_ssl %}ğŸ”’ HTTPS enabled with Let's Encrypt + Cloudflare DNS{% else %}âš ï¸  HTTP only - no SSL configured{% endif %}"
          - ""
          - "ğŸ“ Next steps:"
          - "  1. Add services to the traefik network"
          - "  2. Configure traefik labels on your containers"
          - "  3. Monitor dashboard for routing status"
