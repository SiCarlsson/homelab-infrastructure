---
- name: Setup Uptime Kuma for Service Monitoring
  hosts: local_docker_hosts
  become: yes
  gather_facts: yes

  roles:
    - role: ../roles/uptime-kuma

  post_tasks:
    - name: Check Uptime Kuma container status
      command: docker compose ps --services --filter status=running
      args:
        chdir: /opt/uptime-kuma
      register: uptimekuma_running_services
      changed_when: false

    - name: Verify Uptime Kuma container is running
      assert:
        that:
          - uptimekuma_running_services.stdout_lines | length > 0
        fail_msg: "Uptime Kuma container is not running"
        success_msg: "Uptime Kuma container is running successfully"

    - name: Display setup completion
      debug:
        msg:
          - "ğŸ‰ Uptime Kuma setup completed successfully!"
          - "ğŸŒ Access Uptime Kuma at: https://{{ uptimekuma_domain }}"
          - "ğŸ‘¤ Create your admin account on first login"
          - ""
          - "ğŸ“Š Suggested monitors to add:"
          - "  â€¢ Homepage - https://homepage.{{ lookup('env', 'HOMELAB_DOMAIN') }}"
          - "  â€¢ Traefik - https://traefik.{{ lookup('env', 'HOMELAB_DOMAIN') }}"
          - "  â€¢ AdGuard - https://adguard.{{ lookup('env', 'HOMELAB_DOMAIN') }}"
          - "  â€¢ Portainer - https://portainer.{{ lookup('env', 'HOMELAB_DOMAIN') }}"
          - "  â€¢ pgAdmin - https://pgadmin.{{ lookup('env', 'HOMELAB_DOMAIN') }}"
          - "  â€¢ ChangeDetection - https://change.{{ lookup('env', 'HOMELAB_DOMAIN') }}"
          - ""
          - "ğŸ“ Features:"
          - "  âœ… HTTP/HTTPS monitoring"
          - "  âœ… TCP port monitoring"
          - "  âœ… Docker container monitoring"
          - "  âœ… Multiple notification channels"
          - "  âœ… Public status pages"
          - "  âœ… Beautiful dashboards"
